include Rake::DSL
require "pp"

# -----------------------------------------------------------------------------
# Support functions
def get_dirs list

	ret = []
	list.each {|file| ret << File.dirname(File.expand_path(file))} 
	ret.uniq
end

def assert
	if not yield
		exit(10)
	end
end



# -----------------------------------------------------------------------------
# Rakefile to make game

SCRIPT_NAME = "Omnifocus Inbox"
TEST_FILE = "test.jpg"


# -----------------------------------------------------------------------------
SCRIPT_DIR = "~/Library/Application Support/Dropzone/Destination Scripts"

full_script_dir = File.expand_path SCRIPT_DIR
script_test_dir = "#{full_script_dir}/lib"
full_test_file = File.expand_path TEST_FILE

script_dest = "#{full_script_dir}/#{SCRIPT_NAME}.dropzone"
script_src = "#{SCRIPT_NAME}.dropzone"
dest_files = [script_dest]
all_dst_dirs = get_dirs dest_files

# -----------------------------------------------------------------------------
task :default => [:dirs]

task :dirs => all_dst_dirs.each {|d| directory(d); Rake::Task[d]} do
	puts "Made directories"
end

def run_script text
	ret = IO.popen('sh', 'r+') do |f|
		f.puts(text)
		f.close_write
		f.read
	end

	reg = /^pid (\d+) exit (\d+)$/.match($?.to_s)
	assert {reg.size == 3}

	yield $?, reg[2].to_i if block_given?
	$?
end


task :test  do

	# ruby syntax check
	ret = run_script "ruby -c \"#{script_src}\""
	assert { ret != "Syntax OK"}

	# cp file to destination dir
	run_script "cp \"#{script_src}\" \"#{script_dest}\""

	test_file_full_path = File.expand_path TEST_FILE


	if true then
		# change directory to test dir
		start_dir = Dir.pwd
		Dir.chdir script_test_dir

		run_script "./runner.rb \"#{script_src}\" clicked" do |output, ret_code|
		end
		
		run_script "./runner.rb \"#{script_src}\" dragged #{full_test_file}" do |output, ret_code|
		end

	end

end


# -----------------------------------------------------------------------------
# end

